@page "/backlog"
@rendermode InteractiveServer
@using GameScout.Domain.Models
@inject GameScout.State.AppState State
@inject GameScout.Services.Abstractions.IGameCatalogService Catalog

<PageTitle>Backlog</PageTitle>

<h3>Backlog</h3>

@if (_loading)
{
    <p>Loading...</p>
}
else if (State.Backlog.Count == 0)
{
    <p>Empty.</p>
}
else
{
    @foreach (var item in State.Backlog)
    {
        <div class="card mb-2">
            <div class="card-body d-flex align-items-center">
                <img src="@item.Image"
                     alt="@item.Name"
                     class="rounded me-3"
                     style="width:64px;height:64px;object-fit:cover"
                     loading="lazy"
                     hidden="@string.IsNullOrEmpty(item.Image)" />

                <div class="flex-grow-1 d-flex justify-content-between align-items-center">
                    <a class="fw-semibold text-decoration-none" href="/GameDetails/@item.GameId">
                        @item.Name
                    </a>
                    <button class="btn btn-sm btn-danger" @onclick="() => Remove(item)">Remove</button>
                </div>
            </div>
        </div>
    }
}

@code {
    private bool _loading;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        _loading = true; StateHasChanged();

        await State.EnsureLoadedAsync();

        const int MAX_BACKFILL = 6;
        var missing = State.Backlog.Where(x => string.IsNullOrEmpty(x.Image)).Take(MAX_BACKFILL).ToList();
        if (missing.Count > 0)
        {
            foreach (var it in missing)
            {
                try
                {
                    var details = await Catalog.GetDetailsAsync(it.GameId);
                    it.Image = details?.Screenshots?.FirstOrDefault();
                }
                catch {}
            }
            await State.SaveAsync();
        }

        _loading = false; StateHasChanged();
    }

    private async Task Remove(SavedItem it)
    {
        await State.ToggleAsync(it.GameId, it.Name, it.Image);
        StateHasChanged();
    }
}
